<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cassette WebSocket Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .input-group {
      display: flex;
      margin-bottom: 10px;
    }
    .input-group input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px 0 0 4px;
    }
    .input-group button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }
    .logs {
      background-color: #222;
      color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 5px;
      line-height: 1.4;
    }
    .receive {
      color: #4CAF50;
    }
    .send {
      color: #2196F3;
    }
    .error {
      color: #f44336;
    }
    h2 {
      margin-top: 0;
    }
    .flex {
      display: flex;
      gap: 20px;
    }
    .flex > div {
      flex: 1;
    }
    .preset-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .preset-buttons button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .tab-container {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      border: 1px solid #ddd;
      border-bottom: none;
      background-color: white;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    #drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 25px;
      text-align: center;
      margin-bottom: 20px;
      background-color: #f9f9f9;
      transition: all 0.3s;
    }
    #drop-zone.drag-over {
      background-color: #e3f2fd;
      border-color: #2196F3;
    }
    .custom-tabs {
      margin-top: 15px;
    }
    .custom-tab {
      position: relative;
      padding-right: 30px;
    }
    .remove-tab {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loaded-cassettes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .cassette-badge {
      background-color: #e0f7fa;
      color: #006064;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cassette WebSocket Tester</h1>
    
    <div class="card">
      <h2>Load Custom Cassette</h2>
      <div id="drop-zone">
        <p>Drag and drop a cassette file (.js or .wasm) here</p>
        <p>Or</p>
        <input type="file" id="file-input" accept=".js,.wasm">
      </div>
      
      <div class="loaded-cassettes">
        <h3>Loaded Cassettes:</h3>
        <div id="loaded-cassettes-list"></div>
      </div>
    </div>
    
    <div class="tab-container">
      <div class="tab active" data-tab="sandwichs_favs">SandwichsFavs</div>
      <div class="tab" data-tab="sandwich_notes">SandwichNotes</div>
      <div class="tab" data-tab="custom_cassette">CustomCassette</div>
      <div id="custom-tabs" class="custom-tabs"></div>
    </div>
    
    <div class="flex">
      <div class="card">
        <h2>WebSocket Connection</h2>
        <div class="tab-panel active" id="sandwichs_favs-panel">
          <div class="input-group">
            <input type="text" id="sandwichs_favs-url" value="ws://localhost:3001" placeholder="WebSocket URL">
            <button id="sandwichs_favs-connect">Connect</button>
          </div>
        </div>
        
        <div class="tab-panel" id="sandwich_notes-panel">
          <div class="input-group">
            <input type="text" id="sandwich_notes-url" value="ws://localhost:3001" placeholder="WebSocket URL">
            <button id="sandwich_notes-connect">Connect</button>
          </div>
        </div>
        
        <div class="tab-panel" id="custom_cassette-panel">
          <div class="input-group">
            <input type="text" id="custom_cassette-url" value="ws://localhost:3001" placeholder="WebSocket URL">
            <button id="custom_cassette-connect">Connect</button>
          </div>
        </div>
        
        <div id="status" style="margin-top: 10px; font-weight: bold;">Disconnected</div>
      </div>
      
      <div class="card">
        <h2>Send Message</h2>
        <div class="input-group">
          <input type="text" id="message" placeholder='["REQ", "sub1", {"kinds": [1]}]'>
          <button id="send">Send</button>
        </div>
        
        <div class="preset-buttons">
          <button data-message='["REQ", "sub1", {"kinds": [1]}]'>Request Kind 1</button>
          <button data-message='["REQ", "sub2", {"authors": ["e771af0b05c8e95fcdf6feb3500544d2fb1ccd384788e9f490bb3ee28e8ed66f"]}]'>Request by Author</button>
          <button data-message='["REQ", "sub3", {"#t": ["test"]}]'>Request by Tag</button>
          <button data-message='["REQ", "sub4", {"#custom": ["echo"]}]'>Custom: Echo</button>
          <button data-message='["REQ", "sub5", {"#custom": ["random"]}]'>Custom: Random</button>
          <button data-message='["CLOSE", "sub1"]'>Close Sub1</button>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>WebSocket Logs</h2>
      <div class="logs" id="logs"></div>
      <button id="clear-logs" style="margin-top: 10px;">Clear Logs</button>
    </div>
  </div>

  <script>
    let socket;
    let activeTab = 'sandwichs_favs';
    let loadedCassettes = {};
    
    document.addEventListener('DOMContentLoaded', function() {
      // Set up drag and drop for cassette files
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      
      // File input change handler
      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          handleCassetteFile(e.target.files[0]);
        }
      });
      
      // Drag and drop handlers
      dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      
      dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('drag-over');
      });
      
      dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          const files = e.dataTransfer.files;
          for (let i = 0; i < files.length; i++) {
            handleCassetteFile(files[i]);
          }
        }
      });
      
      // Tab switching logic
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Deactivate all tabs
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          
          // Activate clicked tab
          tab.classList.add('active');
          activeTab = tab.dataset.tab;
          
          // Show corresponding panel
          const panelId = `${activeTab}-panel`;
          const panel = document.getElementById(panelId);
          
          if (panel) {
            panel.classList.add('active');
          } else {
            // This is a custom tab, create a panel for it
            createCustomTabPanel(activeTab);
          }
          
          // Close existing socket when switching tabs
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
            addLogEntry('Disconnected from previous cassette', 'error');
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').style.color = '#f44336';
          }
        });
      });
      
      // Connect button logic
      document.querySelectorAll('[id$="-connect"]').forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.id.split('-')[0];
          connectWebSocket(tabId);
        });
      });
      
      // Send message logic
      document.getElementById('send').addEventListener('click', sendMessage);
      
      // Preset button logic
      document.querySelectorAll('.preset-buttons button').forEach(button => {
        button.addEventListener('click', () => {
          document.getElementById('message').value = button.dataset.message;
        });
      });
      
      // Clear logs
      document.getElementById('clear-logs').addEventListener('click', () => {
        document.getElementById('logs').innerHTML = '';
      });
      
      // Update the loaded cassettes display
      updateLoadedCassettesDisplay();
    });
    
    function handleCassetteFile(file) {
      if (!file.name.endsWith('.js') && !file.name.endsWith('.wasm')) {
        addLogEntry(`Invalid file type. Only .js and .wasm files are supported.`, 'error');
        return;
      }
      
      // Generate a unique ID for this cassette
      const cassetteId = generateCassetteId(file.name);
      
      // Create a FileReader to read the file
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          if (file.name.endsWith('.js')) {
            // Handle JS file
            loadJavaScriptCassette(file.name, e.target.result, cassetteId);
          } else {
            // Handle WASM file
            loadWebAssemblyCassette(file.name, e.target.result, cassetteId);
          }
        } catch (error) {
          addLogEntry(`Error loading cassette: ${error.message}`, 'error');
        }
      };
      
      reader.onerror = function() {
        addLogEntry(`Failed to read file: ${file.name}`, 'error');
      };
      
      // Read the file as text for JS or as ArrayBuffer for WASM
      if (file.name.endsWith('.js')) {
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    }
    
    function generateCassetteId(fileName) {
      // Extract base name without extension
      const baseName = fileName.replace(/\.[^/.]+$/, "");
      // Convert to a valid JavaScript identifier
      const validId = baseName.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
      // Add timestamp to ensure uniqueness
      return `${validId}_${Date.now()}`;
    }
    
    function loadJavaScriptCassette(fileName, fileContent, cassetteId) {
      try {
        // Create a script element
        const script = document.createElement('script');
        script.id = `cassette-script-${cassetteId}`;
        script.textContent = fileContent;
        
        // Add a callback to notify when the script is loaded
        const callbackName = `onCassetteLoaded_${cassetteId}`;
        window[callbackName] = function(cassetteName, cassetteObj) {
          // Register the cassette
          registerCassette(cassetteId, fileName, cassetteName, cassetteObj);
        };
        
        // Add code to call the callback when the script is loaded
        script.textContent += `
          // Find the cassette object
          try {
            // Look for common patterns in cassette modules
            let cassetteName = '';
            let cassetteObj = null;
            
            // Check for named exports that have describe method
            for (const key in window) {
              if (typeof window[key] === 'object' && window[key] !== null && typeof window[key].describe === 'function') {
                cassetteName = key;
                cassetteObj = window[key];
                break;
              }
            }
            
            // If found, call the callback
            if (cassetteName && cassetteObj) {
              window.${callbackName}(cassetteName, cassetteObj);
            } else {
              console.error('Could not find a valid cassette object in the loaded script');
            }
          } catch (error) {
            console.error('Error identifying cassette:', error);
          }
        `;
        
        // Add the script to the document
        document.head.appendChild(script);
        
        addLogEntry(`Loading JavaScript cassette: ${fileName}`, 'send');
      } catch (error) {
        addLogEntry(`Failed to load JavaScript cassette: ${error.message}`, 'error');
      }
    }
    
    function loadWebAssemblyCassette(fileName, arrayBuffer, cassetteId) {
      // For WASM, this is more complex and would require more integration
      // This is a placeholder implementation
      addLogEntry('WebAssembly cassette loading is not fully implemented yet', 'error');
      addLogEntry('For WebAssembly cassettes, please use the JavaScript loader file (.js) rather than the .wasm file directly', 'error');
    }
    
    function registerCassette(cassetteId, fileName, cassetteName, cassetteObj) {
      // Add to our loaded cassettes
      loadedCassettes[cassetteId] = {
        id: cassetteId,
        fileName: fileName,
        name: cassetteName,
        instance: cassetteObj
      };
      
      // Add a new tab for this cassette
      addCassetteTab(cassetteId, cassetteName);
      
      // Update the display
      updateLoadedCassettesDisplay();
      
      addLogEntry(`Successfully loaded cassette: ${cassetteName} from ${fileName}`, 'receive');
    }
    
    function addCassetteTab(cassetteId, cassetteName) {
      const customTabsContainer = document.getElementById('custom-tabs');
      
      // Create the tab
      const tab = document.createElement('div');
      tab.className = 'tab custom-tab';
      tab.dataset.tab = cassetteId;
      tab.textContent = cassetteName;
      
      // Add remove button
      const removeButton = document.createElement('button');
      removeButton.className = 'remove-tab';
      removeButton.innerHTML = '&times;';
      removeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        removeCassette(cassetteId);
      });
      
      tab.appendChild(removeButton);
      
      // Add click handler
      tab.addEventListener('click', () => {
        // Deactivate all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        
        // Activate this tab
        tab.classList.add('active');
        activeTab = cassetteId;
        
        // Show or create panel
        const panelId = `${cassetteId}-panel`;
        let panel = document.getElementById(panelId);
        
        if (panel) {
          panel.classList.add('active');
        } else {
          createCustomTabPanel(cassetteId);
        }
        
        // Close existing socket
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
          addLogEntry('Disconnected from previous cassette', 'error');
          document.getElementById('status').textContent = 'Disconnected';
          document.getElementById('status').style.color = '#f44336';
        }
      });
      
      // Add to container
      customTabsContainer.appendChild(tab);
    }
    
    function createCustomTabPanel(cassetteId) {
      // Get the container
      const connectionSection = document.querySelector('.flex > div:first-child');
      
      // Create panel if it doesn't exist
      let panel = document.getElementById(`${cassetteId}-panel`);
      
      if (!panel) {
        panel = document.createElement('div');
        panel.className = 'tab-panel active';
        panel.id = `${cassetteId}-panel`;
        
        // Create input group
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        
        // Create URL input
        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.id = `${cassetteId}-url`;
        urlInput.value = 'ws://localhost:3001';
        urlInput.placeholder = 'WebSocket URL';
        
        // Create connect button
        const connectButton = document.createElement('button');
        connectButton.id = `${cassetteId}-connect`;
        connectButton.textContent = 'Connect';
        connectButton.addEventListener('click', () => {
          connectWebSocket(cassetteId);
        });
        
        // Assemble elements
        inputGroup.appendChild(urlInput);
        inputGroup.appendChild(connectButton);
        panel.appendChild(inputGroup);
        
        // Add to connection section
        connectionSection.appendChild(panel);
      } else {
        panel.classList.add('active');
      }
    }
    
    function removeCassette(cassetteId) {
      // Remove the tab
      const tab = document.querySelector(`.tab[data-tab="${cassetteId}"]`);
      if (tab) tab.remove();
      
      // Remove the panel
      const panel = document.getElementById(`${cassetteId}-panel`);
      if (panel) panel.remove();
      
      // Remove the script
      const script = document.getElementById(`cassette-script-${cassetteId}`);
      if (script) script.remove();
      
      // Remove from loadedCassettes
      if (loadedCassettes[cassetteId]) {
        delete loadedCassettes[cassetteId];
      }
      
      // Update the display
      updateLoadedCassettesDisplay();
      
      // If this was the active tab, switch to default tab
      if (activeTab === cassetteId) {
        const defaultTab = document.querySelector('.tab[data-tab="sandwichs_favs"]');
        if (defaultTab) defaultTab.click();
      }
      
      addLogEntry(`Removed cassette: ${cassetteId}`, 'send');
    }
    
    function updateLoadedCassettesDisplay() {
      const container = document.getElementById('loaded-cassettes-list');
      container.innerHTML = '';
      
      // Add existing built-in cassettes
      const builtInCassettes = ['SandwichsFavs', 'SandwichNotes', 'CustomCassette'];
      
      builtInCassettes.forEach(name => {
        const badge = document.createElement('div');
        badge.className = 'cassette-badge';
        badge.textContent = `${name} (built-in)`;
        container.appendChild(badge);
      });
      
      // Add custom loaded cassettes
      Object.values(loadedCassettes).forEach(cassette => {
        const badge = document.createElement('div');
        badge.className = 'cassette-badge';
        badge.textContent = `${cassette.name} (custom)`;
        container.appendChild(badge);
      });
      
      if (builtInCassettes.length === 0 && Object.keys(loadedCassettes).length === 0) {
        container.textContent = 'No cassettes loaded';
      }
    }
    
    function connectWebSocket(tabId) {
      const url = document.getElementById(`${tabId}-url`).value;
      
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
      
      try {
        socket = new WebSocket(url);
        
        socket.onopen = function(e) {
          addLogEntry(`Connected to ${url}`, 'receive');
          document.getElementById('status').textContent = 'Connected';
          document.getElementById('status').style.color = '#4CAF50';
        };
        
        socket.onmessage = function(event) {
          addLogEntry(`Received: ${event.data}`, 'receive');
          
          try {
            const data = JSON.parse(event.data);
            console.log('Parsed message:', data);
          } catch (e) {
            console.error('Could not parse message:', e);
          }
        };
        
        socket.onclose = function(event) {
          if (event.wasClean) {
            addLogEntry(`Connection closed cleanly, code=${event.code} reason=${event.reason}`, 'error');
          } else {
            addLogEntry('Connection died', 'error');
          }
          document.getElementById('status').textContent = 'Disconnected';
          document.getElementById('status').style.color = '#f44336';
        };
        
        socket.onerror = function(error) {
          addLogEntry(`Error: ${error.message}`, 'error');
          document.getElementById('status').textContent = 'Error';
          document.getElementById('status').style.color = '#f44336';
        };
      } catch (e) {
        addLogEntry(`Connection error: ${e.message}`, 'error');
      }
    }
    
    function sendMessage() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        addLogEntry('Not connected to WebSocket', 'error');
        return;
      }
      
      const message = document.getElementById('message').value;
      
      try {
        // Check if it's valid JSON
        JSON.parse(message);
        
        socket.send(message);
        addLogEntry(`Sent: ${message}`, 'send');
      } catch (e) {
        addLogEntry(`Invalid JSON: ${e.message}`, 'error');
      }
    }
    
    function addLogEntry(message, type = '') {
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
    }
  </script>
</body>
</html> 